# Internal-API-Starter 链路追踪增强 - 完成总结

## ✅ 已完成的工作

### 1. **添加 trace-starter 依赖**
- 在 `internal-api-starter/pom.xml` 中添加了 `trace-starter` 依赖
- 实现了模块间的依赖关系

### 2. **创建 FeignTraceInterceptor（链路追踪拦截器）**
- **位置**: `com.qbit.framework.starter.merchant.interceptor.FeignTraceInterceptor`
- **功能**: 
  - 自动从 MDC 获取 traceId 和 spanId
  - 通过 HTTP 请求头传递到下游服务
  - 为下游服务生成新的 spanId
  - 记录 DEBUG 级别日志

### 3. InternalRequestInterceptor（签名拦截器）

**设计原则**: 保持职责单一

- ✅ 只负责签名功能（添加 `x-sign`、`x-nonce-str`、`x-timestamp` 请求头）
- ✅ 不添加日志功能（日志由 `SingleLineHttpLogger` 负责）
- ✅ 不处理链路追踪（由 `FeignTraceInterceptor` 负责）

**职责分工**:
- `InternalRequestInterceptor` → 签名拦截
- `FeignTraceInterceptor` → 链路追踪传播
- `SingleLineHttpLogger` → HTTP 请求/响应日志

### 4. **更新 FeignAutoConfiguration（自动配置）**
- 添加了 `feignTraceInterceptor` Bean 的自动配置
- 使用 `@ConditionalOnClass` 检测 trace-starter 是否存在
- 支持用户自定义覆盖

### 5. **常量统一管理（重要改进）** ⭐
根据你的反馈，我们将 HTTP 请求头常量沉淀到了 `trace-starter` 模块：

#### 修改的文件：
1. **trace-starter/TraceUtils.java**
   - 添加了 `TRACE_ID_HEADER = "X-Trace-Id"`
   - 添加了 `SPAN_ID_HEADER = "X-Span-Id"`

2. **trace-starter/web/TraceInterceptor.java**
   - 使用 `TraceUtils.TRACE_ID_HEADER` 替代硬编码
   - 使用 `TraceUtils.SPAN_ID_HEADER` 替代硬编码

3. **internal-api-starter/interceptor/FeignTraceInterceptor.java**
   - 移除了本地常量定义
   - 使用 `TraceUtils.TRACE_ID_HEADER` 和 `TraceUtils.SPAN_ID_HEADER`

#### 常量定义（最终版本）：
```java
// trace-starter/src/main/java/com/qbit/framework/starter/trace/TraceUtils.java
public final class TraceUtils {
    // MDC 中的 key
    public static final String TRACE_ID = "traceId";
    public static final String SPAN_ID = "spanId";

    // HTTP 请求头名称
    public static final String TRACE_ID_HEADER = "X-Trace-Id";
    public static final String SPAN_ID_HEADER = "X-Span-Id";
    
    // ... 其他方法
}
```

### 6. **更新文档**
- 更新了 `internal-api-starter/README.md`，添加链路追踪说明
- 创建了 `internal-api-starter/docs/链路追踪增强说明.md` 详细文档
- 更新了文档中的代码示例，使用统一的常量

---

## 📊 架构改进

### 常量管理架构

**改进前**：
```
❌ 分散定义
├─ TraceInterceptor.java
│  └─ "X-Trace-Id" (硬编码)
│  └─ "X-Span-Id" (硬编码)
└─ FeignTraceInterceptor.java
   └─ TRACE_ID_HEADER = "X-Trace-Id" (本地常量)
   └─ SPAN_ID_HEADER = "X-Span-Id" (本地常量)
```

**改进后**：
```
✅ 统一管理
trace-starter/
└─ TraceUtils.java
   ├─ TRACE_ID = "traceId" (MDC key)
   ├─ SPAN_ID = "spanId" (MDC key)
   ├─ TRACE_ID_HEADER = "X-Trace-Id" (HTTP header)
   └─ SPAN_ID_HEADER = "X-Span-Id" (HTTP header)
   
所有模块引用：
├─ TraceInterceptor → TraceUtils.TRACE_ID_HEADER
└─ FeignTraceInterceptor → TraceUtils.TRACE_ID_HEADER
```

### 优势：
1. ✅ **单一数据源** - 所有常量定义在一处
2. ✅ **避免重复** - 消除了魔法字符串
3. ✅ **易于维护** - 修改只需改一处
4. ✅ **类型安全** - 编译时检查
5. ✅ **语义清晰** - 常量名称表达了用途

---

## 🎯 核心功能

### 链路追踪传播流程

```
┌─────────────────────────────────────────────────────────────┐
│  Service A (上游服务)                                        │
│                                                              │
│  1. TraceInterceptor 从请求头提取 traceId/spanId             │
│     └─> 使用 TraceUtils.TRACE_ID_HEADER 读取                │
│     └─> 存储到 MDC (TraceUtils.TRACE_ID, TraceUtils.SPAN_ID)│
│                                                              │
│  2. 业务代码执行 → 调用 Feign Client                         │
│                                                              │
│  3. FeignTraceInterceptor 拦截                               │
│     ├─> 从 MDC 获取 TraceUtils.get(TraceUtils.TRACE_ID)     │
│     ├─> 生成新的 spanId                                      │
│     └─> 添加请求头: TraceUtils.TRACE_ID_HEADER              │
│                     TraceUtils.SPAN_ID_HEADER               │
│                                                              │
│  4. InternalRequestInterceptor 拦截                          │
│     ├─> 添加签名头                                           │
│     └─> 记录日志 (包含 traceId)                              │
│                                                              │
└──────────────────────┬───────────────────────────────────────┘
                       │ HTTP Request
                       │ Headers:
                       │   X-Trace-Id: A
                       │   X-Span-Id: A3
                       │   x-sign: xxx
                       ↓
┌─────────────────────────────────────────────────────────────┐
│  Service B (下游服务)                                        │
│                                                              │
│  1. TraceInterceptor 从请求头提取                            │
│     └─> 使用 TraceUtils.TRACE_ID_HEADER 读取                │
│     └─> 存储到 MDC                                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 使用示例

### 1. 基本使用（零配置）

```java
@Service
public class OrderService {
    @Autowired
    private UserFeignClient userFeignClient;
    
    public void createOrder(Long userId) {
        // traceId 和 spanId 会自动传递
        User user = userFeignClient.getUserById(userId);
        // ...
    }
}
```

### 2. 启用 DEBUG 日志

```yaml
logging:
  level:
    com.qbit.framework.starter.merchant.interceptor: DEBUG
```

日志输出：
```
DEBUG - Feign request trace propagation: traceId=550e8400-e29b-41d4-a716-446655440000
DEBUG - Feign request trace propagation: spanId=660e8400-e29b-41d4-a716-446655440001 (new spanId for downstream: 770e8400-e29b-41d4-a716-446655440002)
DEBUG - Internal API request [traceId=550e8400-e29b-41d4-a716-446655440000]: POST /api/users - signature headers added
```

### 3. 自定义使用常量

如果其他模块需要使用链路追踪相关的常量：

```java
import com.qbit.framework.starter.trace.TraceUtils;

// 读取 MDC 中的 traceId
String traceId = TraceUtils.get(TraceUtils.TRACE_ID);

// 设置自定义请求头
request.setHeader(TraceUtils.TRACE_ID_HEADER, traceId);

// 在日志中输出
log.info("Processing request [{}={}]", TraceUtils.TRACE_ID, traceId);
```

---

## 🔧 技术细节

### 拦截器执行顺序

```
HTTP Request
    ↓
1. FeignTraceInterceptor
   └─> 添加: X-Trace-Id, X-Span-Id
    ↓
2. InternalRequestInterceptor
   └─> 添加: x-sign, x-nonce-str, x-timestamp
   └─> 记录日志 (包含 traceId)
    ↓
发送到下游服务
```

### 自动配置条件

```java
@Bean
@ConditionalOnMissingBean(name = "feignTraceInterceptor")
@ConditionalOnClass(name = "com.qbit.framework.starter.trace.TraceUtils")
public RequestInterceptor feignTraceInterceptor() {
    return new FeignTraceInterceptor();
}
```

- ✅ 只有当 `trace-starter` 存在时才启用
- ✅ 支持用户自定义覆盖
- ✅ 零配置，自动生效

---

## 📚 相关文档

1. **README.md** - 快速开始和配置说明
2. **docs/链路追踪增强说明.md** - 详细的设计文档
3. **docs/BeanFactoryPostProcessor注册方式.md** - 现有文档

---

## 🎉 总结

通过本次增强，`internal-api-starter` 模块现在具备了：

✅ **完整的链路追踪能力** - 自动传播 traceId 和 spanId  
✅ **统一的常量管理** - 所有常量定义在 TraceUtils 中  
✅ **零侵入集成** - 业务代码无需修改  
✅ **详细的日志记录** - 便于调试和问题排查  
✅ **灵活的配置** - 支持自定义和条件装配  
✅ **完善的文档** - 提供了详细的使用说明  

这为构建可观测的微服务架构提供了坚实的基础！🚀
