# Internal-API-Starter é“¾è·¯è¿½è¸ªå¢å¼º - å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. **æ·»åŠ  trace-starter ä¾èµ–**
- åœ¨ `internal-api-starter/pom.xml` ä¸­æ·»åŠ äº† `trace-starter` ä¾èµ–
- å®ç°äº†æ¨¡å—é—´çš„ä¾èµ–å…³ç³»

### 2. **åˆ›å»º FeignTraceInterceptorï¼ˆé“¾è·¯è¿½è¸ªæ‹¦æˆªå™¨ï¼‰**
- **ä½ç½®**: `com.qbit.framework.starter.merchant.interceptor.FeignTraceInterceptor`
- **åŠŸèƒ½**: 
  - è‡ªåŠ¨ä» MDC è·å– traceId å’Œ spanId
  - é€šè¿‡ HTTP è¯·æ±‚å¤´ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡
  - ä¸ºä¸‹æ¸¸æœåŠ¡ç”Ÿæˆæ–°çš„ spanId
  - è®°å½• DEBUG çº§åˆ«æ—¥å¿—

### 3. **InternalRequestInterceptorï¼ˆç­¾åæ‹¦æˆªå™¨ï¼‰**

**è®¾è®¡åŸåˆ™**: ä¿æŒèŒè´£å•ä¸€

- âœ… åªè´Ÿè´£ç­¾ååŠŸèƒ½ï¼ˆæ·»åŠ  `x-sign`ã€`x-nonce-str`ã€`x-timestamp` è¯·æ±‚å¤´ï¼‰
- âœ… ä¸æ·»åŠ æ—¥å¿—åŠŸèƒ½ï¼ˆæ—¥å¿—ç”± `SingleLineHttpLogger` è´Ÿè´£ï¼‰
- âœ… ä¸å¤„ç†é“¾è·¯è¿½è¸ªï¼ˆç”± `FeignTraceInterceptor` è´Ÿè´£ï¼‰

**èŒè´£åˆ†å·¥**:
- `InternalRequestInterceptor` â†’ ç­¾åæ‹¦æˆª
- `FeignTraceInterceptor` â†’ é“¾è·¯è¿½è¸ªä¼ æ’­
- `SingleLineHttpLogger` â†’ HTTP è¯·æ±‚/å“åº”æ—¥å¿—

### 4. **æ›´æ–° FeignAutoConfigurationï¼ˆè‡ªåŠ¨é…ç½®ï¼‰**
- æ·»åŠ äº† `feignTraceInterceptor` Bean çš„è‡ªåŠ¨é…ç½®
- ä½¿ç”¨ `@ConditionalOnClass` æ£€æµ‹ trace-starter æ˜¯å¦å­˜åœ¨
- æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è¦†ç›–

### 5. **å¸¸é‡ç»Ÿä¸€ç®¡ç†ï¼ˆé‡è¦æ”¹è¿›ï¼‰** â­
æ ¹æ®ä½ çš„åé¦ˆï¼Œæˆ‘ä»¬å°† HTTP è¯·æ±‚å¤´å¸¸é‡æ²‰æ·€åˆ°äº† `trace-starter` æ¨¡å—ï¼š

#### ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. **trace-starter/TraceUtils.java**
   - æ·»åŠ äº† `TRACE_ID_HEADER = "X-Trace-Id"`
   - æ·»åŠ äº† `SPAN_ID_HEADER = "X-Span-Id"`

2. **trace-starter/web/TraceInterceptor.java**
   - ä½¿ç”¨ `TraceUtils.TRACE_ID_HEADER` æ›¿ä»£ç¡¬ç¼–ç 
   - ä½¿ç”¨ `TraceUtils.SPAN_ID_HEADER` æ›¿ä»£ç¡¬ç¼–ç 

3. **internal-api-starter/interceptor/FeignTraceInterceptor.java**
   - ç§»é™¤äº†æœ¬åœ°å¸¸é‡å®šä¹‰
   - ä½¿ç”¨ `TraceUtils.TRACE_ID_HEADER` å’Œ `TraceUtils.SPAN_ID_HEADER`

#### å¸¸é‡å®šä¹‰ï¼ˆæœ€ç»ˆç‰ˆæœ¬ï¼‰ï¼š
```java
// trace-starter/src/main/java/com/qbit/framework/starter/trace/TraceUtils.java
public final class TraceUtils {
    // MDC ä¸­çš„ key
    public static final String TRACE_ID = "traceId";
    public static final String SPAN_ID = "spanId";

    // HTTP è¯·æ±‚å¤´åç§°
    public static final String TRACE_ID_HEADER = "X-Trace-Id";
    public static final String SPAN_ID_HEADER = "X-Span-Id";
    
    // ... å…¶ä»–æ–¹æ³•
}
```

### 6. **æ›´æ–°æ–‡æ¡£**
- æ›´æ–°äº† `internal-api-starter/README.md`ï¼Œæ·»åŠ é“¾è·¯è¿½è¸ªè¯´æ˜
- åˆ›å»ºäº† `internal-api-starter/docs/é“¾è·¯è¿½è¸ªå¢å¼ºè¯´æ˜.md` è¯¦ç»†æ–‡æ¡£
- æ›´æ–°äº†æ–‡æ¡£ä¸­çš„ä»£ç ç¤ºä¾‹ï¼Œä½¿ç”¨ç»Ÿä¸€çš„å¸¸é‡

---

## ğŸ“Š æ¶æ„æ”¹è¿›

### å¸¸é‡ç®¡ç†æ¶æ„

**æ”¹è¿›å‰**ï¼š
```
âŒ åˆ†æ•£å®šä¹‰
â”œâ”€ TraceInterceptor.java
â”‚  â””â”€ "X-Trace-Id" (ç¡¬ç¼–ç )
â”‚  â””â”€ "X-Span-Id" (ç¡¬ç¼–ç )
â””â”€ FeignTraceInterceptor.java
   â””â”€ TRACE_ID_HEADER = "X-Trace-Id" (æœ¬åœ°å¸¸é‡)
   â””â”€ SPAN_ID_HEADER = "X-Span-Id" (æœ¬åœ°å¸¸é‡)
```

**æ”¹è¿›å**ï¼š
```
âœ… ç»Ÿä¸€ç®¡ç†
trace-starter/
â””â”€ TraceUtils.java
   â”œâ”€ TRACE_ID = "traceId" (MDC key)
   â”œâ”€ SPAN_ID = "spanId" (MDC key)
   â”œâ”€ TRACE_ID_HEADER = "X-Trace-Id" (HTTP header)
   â””â”€ SPAN_ID_HEADER = "X-Span-Id" (HTTP header)
   
æ‰€æœ‰æ¨¡å—å¼•ç”¨ï¼š
â”œâ”€ TraceInterceptor â†’ TraceUtils.TRACE_ID_HEADER
â””â”€ FeignTraceInterceptor â†’ TraceUtils.TRACE_ID_HEADER
```

### ä¼˜åŠ¿ï¼š
1. âœ… **å•ä¸€æ•°æ®æº** - æ‰€æœ‰å¸¸é‡å®šä¹‰åœ¨ä¸€å¤„
2. âœ… **é¿å…é‡å¤** - æ¶ˆé™¤äº†é­”æ³•å­—ç¬¦ä¸²
3. âœ… **æ˜“äºç»´æŠ¤** - ä¿®æ”¹åªéœ€æ”¹ä¸€å¤„
4. âœ… **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶æ£€æŸ¥
5. âœ… **è¯­ä¹‰æ¸…æ™°** - å¸¸é‡åç§°è¡¨è¾¾äº†ç”¨é€”

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### é“¾è·¯è¿½è¸ªä¼ æ’­æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service A (ä¸Šæ¸¸æœåŠ¡)                                        â”‚
â”‚                                                              â”‚
â”‚  1. TraceInterceptor ä»è¯·æ±‚å¤´æå– traceId/spanId             â”‚
â”‚     â””â”€> ä½¿ç”¨ TraceUtils.TRACE_ID_HEADER è¯»å–                â”‚
â”‚     â””â”€> å­˜å‚¨åˆ° MDC (TraceUtils.TRACE_ID, TraceUtils.SPAN_ID)â”‚
â”‚                                                              â”‚
â”‚  2. ä¸šåŠ¡ä»£ç æ‰§è¡Œ â†’ è°ƒç”¨ Feign Client                         â”‚
â”‚                                                              â”‚
â”‚  3. FeignTraceInterceptor æ‹¦æˆª                               â”‚
â”‚     â”œâ”€> ä» MDC è·å– TraceUtils.get(TraceUtils.TRACE_ID)     â”‚
â”‚     â”œâ”€> ç”Ÿæˆæ–°çš„ spanId                                      â”‚
â”‚     â””â”€> æ·»åŠ è¯·æ±‚å¤´: TraceUtils.TRACE_ID_HEADER              â”‚
â”‚                     TraceUtils.SPAN_ID_HEADER               â”‚
â”‚                                                              â”‚
â”‚  4. InternalRequestInterceptor æ‹¦æˆª                          â”‚
â”‚     â””â”€> æ·»åŠ ç­¾åå¤´ï¼ˆx-sign, x-nonce-str, x-timestampï¼‰      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP Request
                       â”‚ Headers:
                       â”‚   X-Trace-Id: A
                       â”‚   X-Span-Id: A3
                       â”‚   x-sign: xxx
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service B (ä¸‹æ¸¸æœåŠ¡)                                        â”‚
â”‚                                                              â”‚
â”‚  1. TraceInterceptor ä»è¯·æ±‚å¤´æå–                            â”‚
â”‚     â””â”€> ä½¿ç”¨ TraceUtils.TRACE_ID_HEADER è¯»å–                â”‚
â”‚     â””â”€> å­˜å‚¨åˆ° MDC                                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ä½¿ç”¨ï¼ˆé›¶é…ç½®ï¼‰

```java
@Service
public class OrderService {
    @Autowired
    private UserFeignClient userFeignClient;
    
    public void createOrder(Long userId) {
        // traceId å’Œ spanId ä¼šè‡ªåŠ¨ä¼ é€’
        User user = userFeignClient.getUserById(userId);
        // ...
    }
}
```

### 2. å¯ç”¨ DEBUG æ—¥å¿—

```yaml
logging:
  level:
    com.qbit.framework.starter.merchant.interceptor: DEBUG
```

æ—¥å¿—è¾“å‡ºï¼š
```
DEBUG - Feign request trace propagation: traceId=550e8400-e29b-41d4-a716-446655440000
DEBUG - Feign request trace propagation: spanId=660e8400-e29b-41d4-a716-446655440001 (new spanId for downstream: 770e8400-e29b-41d4-a716-446655440002)
DEBUG - Internal API request [traceId=550e8400-e29b-41d4-a716-446655440000]: POST /api/users - signature headers added
```

### 3. è‡ªå®šä¹‰ä½¿ç”¨å¸¸é‡

å¦‚æœå…¶ä»–æ¨¡å—éœ€è¦ä½¿ç”¨é“¾è·¯è¿½è¸ªç›¸å…³çš„å¸¸é‡ï¼š

```java
import tracing.toolkits.com.qbit.framework.core.api.model.TraceUtils;

// è¯»å– MDC ä¸­çš„ traceId
String traceId = TraceUtils.get(TraceUtils.TRACE_ID);

// è®¾ç½®è‡ªå®šä¹‰è¯·æ±‚å¤´
request.

        setHeader(TraceUtils.TRACE_ID_HEADER, traceId);

// åœ¨æ—¥å¿—ä¸­è¾“å‡º
log.

        info("Processing request [{}={}]",TraceUtils.TRACE_ID, traceId);
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº

Feign çš„å¤šä¸ª `RequestInterceptor` ä¼šæŒ‰ç…§æ³¨å†Œé¡ºåºæ‰§è¡Œï¼š

1. **FeignTraceInterceptor** - æ·»åŠ é“¾è·¯è¿½è¸ªå¤´ï¼ˆ`X-Trace-Id`ã€`X-Span-Id`ï¼‰
2. **InternalRequestInterceptor** - æ·»åŠ ç­¾åå¤´ï¼ˆ`x-sign`ã€`x-nonce-str`ã€`x-timestamp`ï¼‰

**èŒè´£åˆ†ç¦»**ï¼š
- æ¯ä¸ªæ‹¦æˆªå™¨ä¸“æ³¨äºè‡ªå·±çš„èŒè´£
- äº’ä¸å¹²æ‰°ï¼Œå„å¸å…¶èŒ
- æ—¥å¿—ç”± `SingleLineHttpLogger` ç»Ÿä¸€å¤„ç†ï¼ˆåœ¨ OkHttp å±‚é¢ï¼‰

```
HTTP Request
    â†“
1. FeignTraceInterceptor
   â””â”€> æ·»åŠ : X-Trace-Id, X-Span-Id
    â†“
2. InternalRequestInterceptor
   â””â”€> æ·»åŠ : x-sign, x-nonce-str, x-timestamp
    â†“
å‘é€åˆ°ä¸‹æ¸¸æœåŠ¡
```

### è‡ªåŠ¨é…ç½®æ¡ä»¶

```java
@Bean
@ConditionalOnMissingBean(name = "feignTraceInterceptor")
@ConditionalOnClass(name = "tracing.toolkits.com.qbit.framework.core.api.model.TraceUtils")
public RequestInterceptor feignTraceInterceptor() {
    return new FeignTraceInterceptor();
}
```

- âœ… åªæœ‰å½“ `trace-starter` å­˜åœ¨æ—¶æ‰å¯ç”¨
- âœ… æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è¦†ç›–
- âœ… é›¶é…ç½®ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **README.md** - å¿«é€Ÿå¼€å§‹å’Œé…ç½®è¯´æ˜
2. **docs/é“¾è·¯è¿½è¸ªå¢å¼ºè¯´æ˜.md** - è¯¦ç»†çš„è®¾è®¡æ–‡æ¡£
3. **docs/BeanFactoryPostProcessoræ³¨å†Œæ–¹å¼.md** - ç°æœ‰æ–‡æ¡£

---

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡å¢å¼ºï¼Œ`internal-api-starter` æ¨¡å—ç°åœ¨å…·å¤‡äº†ï¼š

âœ… **å®Œæ•´çš„é“¾è·¯è¿½è¸ªèƒ½åŠ›** - è‡ªåŠ¨ä¼ æ’­ traceId å’Œ spanId  
âœ… **ç»Ÿä¸€çš„å¸¸é‡ç®¡ç†** - æ‰€æœ‰å¸¸é‡å®šä¹‰åœ¨ TraceUtils ä¸­  
âœ… **é›¶ä¾µå…¥é›†æˆ** - ä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹  
âœ… **è¯¦ç»†çš„æ—¥å¿—è®°å½•** - ä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥  
âœ… **çµæ´»çš„é…ç½®** - æ”¯æŒè‡ªå®šä¹‰å’Œæ¡ä»¶è£…é…  
âœ… **å®Œå–„çš„æ–‡æ¡£** - æä¾›äº†è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜  

è¿™ä¸ºæ„å»ºå¯è§‚æµ‹çš„å¾®æœåŠ¡æ¶æ„æä¾›äº†åšå®çš„åŸºç¡€ï¼ğŸš€
